#!/bin/bash

# This helper script turns a stage3 image into a server chroot image.
#
# Prior to running this script:
#
# 1. Make sure cfengine created /var/image/server/x86_64/no_multilib
# 2. Extract a stage3-amd64-nomultilib- image to the above directory
# 3. 'mount -a' to make sure all bind mounts are active
# 4. 'cf-agent -K' to have cfengine configure Portage in the image


# Update @system, mostly to get recent versions of Portage and GCC

/usr/cryptoo/bin/emerge_server -uD --reinstall changed-use @system &&


# Allow cfengine to restore any configuration disturbed by the previous step
# and update gcc profile, if needed

/usr/local/sbin/cf-agent -K &&


# Remove udev to make room for systemd

/usr/cryptoo/bin/emerge_server -C udev &&


# Solve a circular dependency with dbus by installing a minimal systemd

USE="-*" /usr/cryptoo/bin/emerge_server -1 --nodeps systemd &&


# Allow cfengine to note existance of systemd and adjust appropriately

/usr/local/sbin/cf-agent -K &&


# Update @system with systemd enabled

/usr/cryptoo/bin/emerge_server -uD --reinstall changed-use --with-bdeps=y @system


# Install the remaining packages in the @server_chroot set

/usr/cryptoo/bin/emerge_server -e --usepkg=n @world


# In case any packages above failed due to unspecified circular dependencies,
# try again.

/usr/cryptoo/bin/emerge_server -uD --reinstall changed-use --with-bdeps=y @world
