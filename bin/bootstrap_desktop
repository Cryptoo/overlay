#!/bin/bash

# This helper script turns a stage3 image into a desktop template image.
#
# Prior to running this script:
#
# 1. Make sure cfengine created /var/image/desktop/x86_64/no-multilib
# 2. Extract a stage3-amd64-nomultilib- image to the above directory
# 3. 'mount -a' to make sure all bind mounts are active
# 4. 'cf-agent -K' to have cfengine configure Portage in the image


# Currently (2015-03-04) all stage3 images ship with OpenRC/udev instead of
# systemd. Remove udev-init-scripts now so they aren't in the way later.

emerge_desktop -C udev-init-scripts &&


# Update @system, mostly to get recent versions of Portage and GCC

emerge_desktop -uD --reinstall changed-use @system &&


# Allow cfengine to restore any configuration disturbed by the previous step
# and update gcc profile, if needed

/usr/local/sbin/cf-agent -K &&


# Remove udev to make room for systemd

emerge_desktop -C udev &&


# Solve a circular dependency with dbus by installing a minimal systemd

USE="-*" emerge_desktop -1 --nodeps systemd &&


# Allow cfengine to note existance of systemd and adjust appropriately

/usr/local/sbin/cf-agent -K &&


# Update @system with systemd enabled

emerge_desktop -uD --reinstall changed-use --with-bdeps=y @system


# Install the remaining packages in the @desktop_template set

emerge_desktop -e --usepkg=n @world


# In case any packages above failed due to unspecified circular dependencies,
# try again.

emerge_desktop -uD --reinstall changed-use --with-bdeps=y @world
